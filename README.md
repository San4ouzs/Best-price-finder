
# Best Price Finder (CLI)

Небольшая утилита на Python, которая по названию/модели товара находит минимальные цены в онлайн‑магазинах.
Работает двумя путями:
1) **Поисковый**: собирает ссылки из DuckDuckGo (без ключей API), затем открывает страницы магазинов и извлекает цену.
2) **Точечный (провайдеры)**: если в `sites.yaml` указан домен и CSS‑селекторы цены, сканер применит их в приоритете (точнее и быстрее).

> ⚠️ Веб‑сайты часто обновляют разметку и блокируют агрессивный парсинг. Этот проект — аккуратный, расширяемый **инструмент для персонального использования**. 
> Уважайте robots.txt/условия использования сайтов и действуйте в рамках закона вашей юрисдикции.

---

## Возможности
- Ввод: название/модель товара (например, `iPhone 15 128GB`).
- Поиск и парсинг цен из нескольких магазинов, выбор минимальной цены.
- Нормализация валют с автоматической конвертацией (по курсу [exchangerate.host](https://exchangerate.host) при необходимости).
- Фильтр по доменам/странам/валютах (через `sites.yaml`).
- Результат: таблица в консоли + CSV/JSON файлы с деталями.
- Плагин‑архитектура: легко добавлять магазины через `sites.yaml` (без редактирования кода).
- Headless‑рендеринг (Playwright) для динамических страниц; есть «быстрый» режим без рендера.

---

## Установка

1) Установите Python 3.10+
2) Создайте виртуальное окружение и установите зависимости:
```bash
python -m venv .venv
. .venv/Scripts/activate  # Windows PowerShell: .\.venv\Scripts\Activate.ps1
pip install -r requirements.txt
```
3) Установите браузер для Playwright (нужно один раз):
```bash
python -m playwright install
```
*(Опционально)* Если хотите пользоваться headful-режимом для отладки:
```bash
python -m playwright install chromium
```

4) (Опционально) Создайте файл `.env` рядом с `main.py` и пропишите:
```
OUTPUT_DIR=outputs
DEFAULT_CURRENCY=EUR
EXCHANGE_API=https://api.exchangerate.host/latest
SEARCH_ENGINE=duckduckgo
```
*`.env` можно не создавать — есть значения по умолчанию.*

---

## Как запустить

### Простой пример
```bash
python main.py "iPhone 15 128GB"
```

### С ограничением по доменам (только из списка в sites.yaml)
```bash
python main.py "PlayStation 5" --only-listed
```

### Быстрый режим (без рендера JS)
```bash
python main.py "Samsung 980 Pro 1TB" --fast
```

### Принудительная валюта результата (конвертирует все цены к заданной)
```bash
python main.py "Ryzen 7 5800X" --currency EUR
```

### Сохранить в CSV и JSON
```bash
python main.py "Kindle Paperwhite" --save
```

### Указать количество ссылок из поиска
```bash
python main.py "AirPods Pro 2" --max-links 25
```

### Вывод только Топ‑N дешёвых
```bash
python main.py "DJI Mini 4 Pro" --top 5
```

---

## Формат `sites.yaml`
Файл описывает магазины и способ извлечения цены. Минимальный пример:
```yaml
sites:
  - domain: "store.google.com"
    country: "EU"
    currency: "EUR"
    price_selectors:
      - '[itemprop="price"]'
      - 'meta[itemprop="price"]::attr(content)'
    blocklist_selectors:
      - ".price--strikethrough"
  - domain: "www.bhphotovideo.com"
    country: "US"
    currency: "USD"
    price_selectors:
      - ".price__value"
```

- `price_selectors` — список CSS‑селекторов (поддерживаются `::attr(name)` для атрибута).
- `blocklist_selectors` — элементы, которые надо игнорировать (например, зачёркнутая старая цена).
- `country`, `currency` — для фильтрации и подсказки конвертации.

> Вы можете добавлять/удалять сайты, ничего не меняя в коде.

---

## Ограничения и советы
- Чем точнее запрос (полное название модели, артикул), тем лучше результат.
- Для сложных динамических сайтов используйте режим без `--fast` (Playwright отрисует страницу).
- Если мало релевантных ссылок — увеличьте `--max-links` или расширьте `sites.yaml`.
- На некоторых сайтах цены появляются только после выбора конфигурации/местоположения — тут поможет ручной запуск `--debug` и корректировка селекторов.
- Уважайте лимиты и не штурмуйте один и тот же сайт слишком часто — добавлен **джиттер** и **повторы с таймаутом**.

---

## Лицензия
MIT
